!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.sc=t():e.sc=t()}(self,(function(){return(()=>{"use strict";var e=[function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),i=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||s(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),i(n(1),t),i(n(2),t),i(n(4),t),i(n(3),t)},(e,t)=>{function n(e,t){throw`${e}: ${t}`}Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidValue=t.KnowledgeBaseError=void 0,t.KnowledgeBaseError=function(e){n("Invalid state of knowledge base",e)},t.InvalidValue=function(e){n("Invalid value: ",e)}},function(e,t,n){var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(i,r){function o(e){try{l(s.next(e))}catch(e){r(e)}}function a(e){try{l(s.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}l((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ScNet=t.ScTemplateResult=t.ScConstruction=t.ScLinkContent=t.ScLinkContentType=t.ScTemplate=t.ScEvent=t.ScEventParams=t.ScEventType=void 0;const i=n(3),r=n(1);var o,a;(a=t.ScEventType||(t.ScEventType={})).Unknown="unknown",a.AddOutgoingEdge="add_outgoing_edge",a.AddIngoingEdge="add_ingoing_edge",a.RemoveOutgoingEdge="remove_outgoing_edge",a.RemoveIngoingEdge="remove_ingoing_edge",a.RemoveElement="delete_element",a.ChangeContent="content_change",t.ScEventParams=class{constructor(e,t,n){this._addr=e,this._type=t,this._callback=n}get addr(){return this._addr}get type(){return this._type}get callback(){return this._callback}};class l{constructor(e,t,n){this._id=0,this._type=null,this._callback=null,this._id=e,this._type=t,this._callback=n}get id(){return this._id}get type(){return this._type}get callback(){return this._callback}IsValid(){return this._id>0}}t.ScEvent=l,t.ScTemplate=class{constructor(){this._triples=[]}ForEachSearchTriple(e){for(let t=0;t<this._triples.length;++t)e(this._triples[t])}Triple(e,t,n){const s=this.SplitTemplateParam(e),i=this.SplitTemplateParam(t),r=this.SplitTemplateParam(n);return this._triples.length,this._triples.push({source:s,edge:i,target:r}),this}TripleWithRelation(e,t,n,s,i){let{alias:r,value:o}=this.SplitTemplateParam(t);return r||(r=`edge_1_${this._triples.length}`),this.Triple(e,[o,r],n),this.Triple(i,s,r),this}SplitTemplateParam(e){if(e instanceof Array){if(2!=e.length)throw"Invalid number of values for remplacement. Use [ScType | ScAddr, string]";const t=e[0],n=e[1];if(!(t instanceof i.ScAddr||t instanceof i.ScType)||"string"!=typeof n)throw"First parameter should be ScAddr or ScType. The second one - string";return{alias:n,value:t}}return{alias:null,value:e}}};class d{constructor(e,t){this._elType=e,this._data=t}get type(){return this._elType}get data(){return this._data}}!function(e){e[e.Int=0]="Int",e[e.Float=1]="Float",e[e.String=2]="String",e[e.Binary=3]="Binary"}(o=t.ScLinkContentType||(t.ScLinkContentType={}));class c{constructor(e,t,n){this._data=e,this._type=t,this._addr=n}get data(){return this._data}get type(){return this._type}get addr(){return this._addr}TypeToStr(){return this._type==o.Binary?"binary":this._type==o.Float?"float":this._type==o.Int?"int":"string"}}t.ScLinkContent=c,t.ScConstruction=class{constructor(){this._commands=[],this._aliases=new Map}CreateNode(e,t){e.isNode()||r.InvalidValue("You should pass node type there");const n=new d(e);t&&(this._aliases[t]=this._commands.length),this._commands.push(n)}CreateEdge(e,t,n,s){e.isEdge()||r.InvalidValue("You should pass edge type there");const i=new d(e,{src:t,trg:n});s&&(this._aliases[s]=this._commands.length),this._commands.push(i)}CreateLink(e,t,n){e.isLink()||r.InvalidValue("You should pass link type there");const s=new d(e,{content:t.data,type:t.type});n&&(this._aliases[n]=this._commands.length),this._commands.push(s)}get commands(){return this._commands}GetIndex(e){return this._aliases[e]}};class u{constructor(e,t){this._addrs=[],this._indecies=null,this._indecies=e,this._addrs=t}get size(){return this._addrs.length}Get(e){return"string"==typeof e?this._addrs[this._indecies[e]]:this._addrs[e]}ForEachTriple(e){for(let t=0;t<this.size;t+=3)e(this._addrs[t],this._addrs[t+1],this._addrs[t+2])}}t.ScTemplateResult=u,t.ScNet=class{constructor(e,t,n,s){this._url=e,this._socket=new WebSocket(this._url),this._socket.onopen=t,this._socket.onclose=n,this._socket.onerror=s,this._socket.onmessage=this.onMessage.bind(this),this._callbacks=new Map,this._events=new Map,this._eventID=1}onMessage(e){const t=JSON.parse(e.data),n=t.id,s=this._callbacks[n];if(t.event){const e=this._events[n];if(!e)throw`Can't find callback for an event ${n}`;e.callback(new i.ScAddr(t.payload[0]),new i.ScAddr(t.payload[1]),new i.ScAddr(t.payload[2]))}else{if(!s)throw`Can't find callback for a command ${n}`;delete this._callbacks[n],s(t)}}sendMessage(e,t,n){if(this._eventID++,this._callbacks[this._eventID])throw"Invalid state of messages queue";this._callbacks[this._eventID]=n,this._socket.send(JSON.stringify({id:this._eventID,type:e,payload:t}))}CheckElements(e){return s(this,void 0,void 0,(function*(){const t=this;return new Promise((function(n){if(0==e.length)n([]);else{const s=e.map((e=>e.value));t.sendMessage("check_elements",s,(e=>{const t=e.payload.map((e=>new i.ScType(e)));n(t)}))}}))}))}CreateElements(e){return s(this,void 0,void 0,(function*(){const t=this;return new Promise((function(n){let s=e.commands.map((t=>{if(t.type.isNode())return{el:"node",type:t.type.value};if(t.type.isEdge()){function n(t){if(t instanceof i.ScAddr)return{type:"addr",value:t.value};const n=e.GetIndex(t);return void 0===n&&r.InvalidValue(`Invalid alias: ${t}`),{type:"ref",value:n}}return{el:"edge",type:t.type.value,src:n(t.data.src),trg:n(t.data.trg)}}if(t.type.isLink())return{el:"link",type:t.type.value,content:t.data.content,content_type:t.data.type};r.InvalidValue("Unknown type")}));t.sendMessage("create_elements",s,(e=>{n(e.payload.map((e=>new i.ScAddr(e))))}))}))}))}DeleteElements(e){return s(this,void 0,void 0,(function*(){const t=this;return new Promise((function(n){const s=e.map((e=>e.value));t.sendMessage("delete_elements",s,(e=>{n(e.status)}))}))}))}SetLinkContents(e){return s(this,void 0,void 0,(function*(){const t=this;return new Promise((function(n){const s=e.map((e=>({command:"set",type:e.TypeToStr(),data:e.data,addr:e.addr.value})));t.sendMessage("content",s,(e=>{n(e.payload)}))}))}))}GetLinkContents(e){return s(this,void 0,void 0,(function*(){const t=this;return new Promise((n=>{const s=e.map((e=>({command:"get",addr:e.value})));t.sendMessage("content",s,(e=>{const t=e.payload.map((e=>{const t=e.type;let n=o.Binary;return"string"==t?n=o.String:"int"==t?n=o.Int:"float"==t&&(n=o.Float),new c(e.value,n)}));n(t)}))}))}))}ResolveKeynodes(e){return s(this,void 0,void 0,(function*(){const t=this;return new Promise((function(n){const s=e.map((e=>e.type.isValid()?{command:"resolve",idtf:e.idtf,elType:e.type.value}:{command:"find",idtf:e.idtf}));t.sendMessage("keynodes",s,(t=>{const s=t.payload.map((e=>new i.ScAddr(e))),r={};for(let t=0;t<s.length;++t)r[e[t].idtf]=s[t];n(r)}))}))}))}ProcessTripleItem(e){let t={};if(e.value instanceof i.ScAddr)t={type:"addr",value:e.value.value};else{if(!(e.value instanceof i.ScType))return{type:"alias",value:e.value};t={type:"type",value:e.value.value}}return e.alias&&(t.alias=e.alias),t}TemplateSearch(e){return s(this,void 0,void 0,(function*(){const t=this;return new Promise((function(n){return s(this,void 0,void 0,(function*(){let s=[];"string"==typeof e?s=e:e.ForEachSearchTriple((e=>{s.push([t.ProcessTripleItem(e.source),t.ProcessTripleItem(e.edge),t.ProcessTripleItem(e.target)])})),t.sendMessage("search_template",s,(e=>{let t=[];if(e.status){const n=e.payload.aliases;e.payload.addrs.forEach((e=>{let s=[];e.forEach((e=>{s.push(new i.ScAddr(e))})),t.push(new u(n,s))}))}n(t)}))}))}))}))}TemplateGenerate(e,t){return s(this,void 0,void 0,(function*(){const n=this;return new Promise((function(r){return s(this,void 0,void 0,(function*(){let s=[];"string"==typeof e?s=e:e.ForEachSearchTriple((e=>{s.push([n.ProcessTripleItem(e.source),n.ProcessTripleItem(e.edge),n.ProcessTripleItem(e.target)])}));const o={};for(let e in t)t.hasOwnProperty(e)&&(o[e]=t[e].value);const a={templ:s,params:o};n.sendMessage("generate_template",a,(e=>{if(e.status){const t=e.payload.aliases,n=e.payload.addrs;let s=[];n.forEach((e=>{s.push(new i.ScAddr(e))})),r(new u(t,s))}r(null)}))}))}))}))}EventsCreate(e){return s(this,void 0,void 0,(function*(){const t=this;return new Promise((function(n){const s={create:e.map((e=>({type:e.type,addr:e.addr.value})))};t.sendMessage("events",s,(s=>{const i=[];for(let n=0;n<e.length;++n){const r=s.payload[n],o=e[n].callback,a=new l(r,e[n].type,o);t._events[r]=a,i.push(a)}n(i)}))}))}))}EventsDestroy(e){return s(this,void 0,void 0,(function*(){const t=this;return new Promise((function(n){const s={delete:e.map((e=>e.id))};t.sendMessage("events",s,(s=>{for(let n=0;n<e.length;++n)delete t._events[e[n].id];n()}))}))}))}}},(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ScAddr=t.ScType=void 0;class n{constructor(e){this._value=e||0}get value(){return this._value}hasConstancy(){return 0!=(96&this._value)}hasDirection(){return 0==(4&this._value)}isNode(){return 0!=(1&this._value)}isEdge(){return 0!=(28&this._value)}isLink(){return 0!=(2&this._value)}isConst(){return 0!=(32&this._value)}isVar(){return 0!=(64&this._value)}isPos(){return 0!=(128&this._value)}isNeg(){return 0!=(256&this._value)}isFuz(){return 0!=(512&this._value)}isPerm(){return 0!=(2048&this._value)}isTemp(){return 0!=(1024&this._value)}isAccess(){return 0!=(16&this._value)}isTuple(){return 0!=(128&this._value)}isStruct(){return 0!=(256&this._value)}isRole(){return 0!=(512&this._value)}isNoRole(){return 0!=(1024&this._value)}isClass(){return 0!=(2048&this._value)}isAbstract(){return 0!=(4096&this._value)}isMaterial(){return 0!=(8192&this._value)}isValid(){return 0!==this._value}equal(e){return this._value===e._value}merge(e){const t=31&this._value,s=31&e._value;if((0!=t||0!=s)&&t!=s)throw"You can't merge two different syntax type";return new n(this._value|e._value)}changeConst(e){const t=-97&this._value;return new n(t|(e?32:64))}}t.ScType=n,n.EdgeUCommon=new n(4),n.EdgeDCommon=new n(8),n.EdgeUCommonConst=new n(36),n.EdgeDCommonConst=new n(40),n.EdgeUCommonVar=new n(68),n.EdgeDCommonVar=new n(72),n.EdgeAccess=new n(16),n.EdgeAccessConstPosPerm=new n(2224),n.EdgeAccessConstNegPerm=new n(2352),n.EdgeAccessConstFuzPerm=new n(2608),n.EdgeAccessConstPosTemp=new n(1200),n.EdgeAccessConstNegTemp=new n(1328),n.EdgeAccessConstFuzTemp=new n(1584),n.EdgeAccessVarPosPerm=new n(2256),n.EdgeAccessVarNegPerm=new n(2384),n.EdgeAccessVarFuzPerm=new n(2640),n.EdgeAccessVarPosTemp=new n(1232),n.EdgeAccessVarNegTemp=new n(1360),n.EdgeAccessVarFuzTemp=new n(1616),n.Const=new n(32),n.Var=new n(64),n.Node=new n(1),n.Link=new n(2),n.Unknown=new n,n.NodeConst=new n(33),n.NodeVar=new n(65),n.LinkConst=new n(34),n.LinkVar=new n(66),n.NodeStruct=new n(257),n.NodeTuple=new n(129),n.NodeRole=new n(513),n.NodeNoRole=new n(1025),n.NodeClass=new n(2049),n.NodeAbstract=new n(4097),n.NodeMaterial=new n(8193),n.NodeConstStruct=new n(289),n.NodeConstTuple=new n(161),n.NodeConstRole=new n(545),n.NodeConstNoRole=new n(1057),n.NodeConstClass=new n(2081),n.NodeConstAbstract=new n(4129),n.NodeConstMaterial=new n(8225),n.NodeVarStruct=new n(321),n.NodeVarTuple=new n(193),n.NodeVarRole=new n(577),n.NodeVarNoRole=new n(1089),n.NodeVarClass=new n(2113),n.NodeVarAbstract=new n(4161),n.NodeVarMaterial=new n(8257),t.ScAddr=class{constructor(e){this._value=e||0}isValid(){return 0!=this._value}get value(){return this._value}equal(e){return this._value===e._value}}},function(e,t,n){var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(i,r){function o(e){try{l(s.next(e))}catch(e){r(e)}}function a(e){try{l(s.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}l((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ScSet=void 0;const i=n(2),r=n(3);t.ScSet=class{constructor(e,t,n,s,i,r){if(this._elements={},this._scNet=null,this._addr=null,this._onAdd=null,this._onRemove=null,this._onInitialize=null,this._filterType=null,this._evtAddElement=null,this._evtRemoveElement=null,this._scNet=e,this._addr=t,this._onInitialize=n,this._onAdd=s,this._onRemove=i,this._filterType=r,!this._addr||!this._addr.isValid())throw`Invalid addr of set: ${this._addr}`}Initialize(){return s(this,void 0,void 0,(function*(){const e=yield this._scNet.EventsCreate([new i.ScEventParams(this._addr,i.ScEventType.AddOutgoingEdge,this.OnEventAddElement.bind(this)),new i.ScEventParams(this._addr,i.ScEventType.RemoveOutgoingEdge,this.OnEventRemoveElement.bind(this))]);return this._evtAddElement=e[0],this._evtRemoveElement=e[1],yield this.IterateExistingElements(),new Promise((function(e){e()}))}))}ShouldAppend(e){return s(this,void 0,void 0,(function*(){const t=this,n=(yield this._scNet.CheckElements(e)).map((e=>!(t._filterType&&(t._filterType.value&e.value)!==t._filterType.value)));return new Promise((function(e){e(n)}))}))}OnEventAddElement(e,t,n){return s(this,void 0,void 0,(function*(){return!this._elements[t.value]&&n.isValid()&&(yield this.ShouldAppend([n]))[0]&&(this._elements[t.value]=n,this.CallOnAdd(n)),new Promise((function(e){e()}))}))}OnEventRemoveElement(e,t){return s(this,void 0,void 0,(function*(){const e=this._elements[t.value];if(!e)throw`Invalid state of set: ${this._addr} (try to remove element ${t}, that doesn't exist)`;return yield this.CallOnRemove(e),delete this._elements[t.value],new Promise((function(e){e()}))}))}CallOnInitialize(e){return s(this,void 0,void 0,(function*(){return this._onInitialize&&(yield this._onInitialize(e)),new Promise((function(e){e()}))}))}CallOnAdd(e){return s(this,void 0,void 0,(function*(){return this._onAdd&&(yield this._onAdd(e)),new Promise((function(e){e()}))}))}CallOnRemove(e){return s(this,void 0,void 0,(function*(){return this._onRemove&&(yield this._onRemove(e)),new Promise((function(e){e()}))}))}IterateExistingElements(){return s(this,void 0,void 0,(function*(){const e=this,t=[],n=new i.ScTemplate;n.Triple(this._addr,[r.ScType.EdgeAccessVarPosPerm,"_edge"],[r.ScType.Unknown,"_item"]);const s=yield this._scNet.TemplateSearch(n),o=s.map((e=>e.Get("_item"))),a=yield e.ShouldAppend(o);for(let n=0;n<s.length;++n){if(!a[n])continue;const i=s[n].Get("_edge"),r=s[n].Get("_item");if(e._elements[i.value])throw`Element ${r} already exist in set`;e._elements[i.value]=r,t.push(r)}return yield this.CallOnInitialize(t),new Promise((function(e){e()}))}))}AddItem(e){return s(this,void 0,void 0,(function*(){let t=!1;const n=new i.ScTemplate;if(n.Triple(this._addr,[r.ScType.EdgeAccessVarPosPerm,"_edge"],[e,"_item"]),0==(yield this._scNet.TemplateSearch(n)).length){const s=yield this._scNet.TemplateGenerate(n,{_item:e});if(s){const e=s.Get("_item");t=e&&e.isValid()}}return new Promise((function(e){e(t)}))}))}}}],t={};return function n(s){if(t[s])return t[s].exports;var i=t[s]={exports:{}};return e[s].call(i.exports,i,i.exports,n),i.exports}(0)})()}));